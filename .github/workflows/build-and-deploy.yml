name: Deploy Application to Azure Web App (Container)

on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy to"
                required: true
                default: "staging"
                type: choice
                options:
                    - staging
                    - production
            tina_branch:
                description: "Tina branch to use"
                required: false
                default: ""
                type: string
            branch_name:
                description: "Source branch name that triggered this deployment"
                required: false
                default: ""
                type: string

concurrency:
    group: ${{ github.ref_name }}-${{ github.event.inputs.environment || 'staging' }}-deployment
    cancel-in-progress: true

permissions:
    id-token: write
    contents: read
    actions: write

jobs:
    # ============================================================================
    # INFRASTRUCTURE DEPLOYMENT
    # ============================================================================
    infrastructure:
        name: Deploy Infrastructure
        uses: ./.github/workflows/deploy-infrastructure.yml
        with:
            environment: ${{ github.event.inputs.environment || 'staging' }}
        secrets:
            AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
            AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
            AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            AZURE_SERVICE_PRINCIPAL_OBJECT_ID: ${{ secrets.AZURE_SERVICE_PRINCIPAL_OBJECT_ID }}
            AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
            AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
            AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
            AUTH0_SECRET: ${{ secrets.AUTH0_SECRET }}
            GH_APP_ID: ${{ vars.GH_APP_ID }}
            GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
            GITHUB_APP_INSTALLATION_ID: ${{ secrets.GITHUB_APP_INSTALLATION_ID }}
            CRM_APP_SECRET: ${{ secrets.CRM_APP_SECRET }}
            CRM_CLIENT_ID: ${{ secrets.CRM_CLIENT_ID }}
            CRM_TENANT: ${{ secrets.CRM_TENANT }}
            TINA_TOKEN: ${{ secrets.TINA_TOKEN }}
            ALGOLIA_SEARCH_KEY: ${{ secrets.ALGOLIA_SEARCH_KEY }}
            ALGOLIA_APP_ID: ${{ secrets.NEXT_PUBLIC_ALGOLIA_APP_ID }}

    # ============================================================================
    # BUILD AND PUSH CONTAINER
    # ============================================================================
    build:
        name: Build and Push Container
        needs: infrastructure
        uses: ./.github/workflows/build-artifacts.yml
        with:
            tag: ${{ github.event.inputs.environment || 'staging' }}
            acr_name: ${{ needs.infrastructure.outputs.acrName }}
            image_name: ssw-rules
            tina_branch: ${{ github.event.inputs.tina_branch }}
            source_branch: ${{ github.event.inputs.branch_name }}
        secrets:
            AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
            AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
            AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            TINA_TOKEN: ${{ secrets.TINA_TOKEN }}
            TINA_SEARCH_TOKEN: ${{ secrets.TINA_SEARCH_TOKEN }}
            TINA_WEBHOOK_SECRET: ${{ secrets.TINA_WEBHOOK_SECRET }}
            NEXT_PUBLIC_TINA_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_TINA_CLIENT_ID }}
            NEXT_PUBLIC_ALGOLIA_APP_ID: ${{ secrets.NEXT_PUBLIC_ALGOLIA_APP_ID }}
            NEXT_PUBLIC_ALGOLIA_ADMIN_KEY: ${{ secrets.NEXT_PUBLIC_ALGOLIA_ADMIN_KEY }}
            NEXT_PUBLIC_ALGOLIA_INDEX_NAME: ${{ secrets.NEXT_PUBLIC_ALGOLIA_INDEX_NAME }}
            NEXT_PUBLIC_ALGOLIA_API_KEY: ${{ secrets.NEXT_PUBLIC_ALGOLIA_API_KEY }}
            NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
            NEXT_PUBLIC_GTM_CONTAINER_ID: ${{ secrets.NEXT_PUBLIC_GTM_CONTAINER_ID }}
            NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING: ${{ secrets.NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING }}
            GH_APP_ID: ${{ vars.GH_APP_ID }}
            GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
            GITHUB_APP_INSTALLATION_ID: ${{ secrets.GITHUB_APP_INSTALLATION_ID }}

    # ============================================================================
    # DEPLOY TO AZURE WEB APP
    # ============================================================================
    deploy:
        name: Deploy to Azure Web App
        runs-on: ubuntu-latest
        needs: [infrastructure, build]
        environment: ${{ github.event.inputs.environment || 'staging' }}
        steps:
            - name: Use build info from build job
              id: build_info
              run: |
                  # Use build info from the build job outputs
                  BUILD_TIMESTAMP="${{ needs.build.outputs.build_timestamp }}"
                  BUILD_DATE="${{ needs.build.outputs.build_date }}"
                  COMMIT_HASH="${{ needs.build.outputs.commit_hash }}"
                  VERSION_DEPLOYED="${{ needs.build.outputs.version_deployed }}"
                  DEPLOYMENT_URL="${{ needs.build.outputs.deployment_url }}"

                  echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
                  echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
                  echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
                  echo "VERSION_DEPLOYED=$VERSION_DEPLOYED" >> $GITHUB_ENV
                  echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV

                  echo "üèóÔ∏è Using Build Info from Build Job:"
                  echo "  Timestamp: $BUILD_TIMESTAMP"
                  echo "  Date: $BUILD_DATE" 
                  echo "  Version: $VERSION_DEPLOYED"
                  echo "  Commit: $COMMIT_HASH"
                  echo "  Deployment URL: $DEPLOYMENT_URL"

            - name: Log deployment info
              run: |
                  echo "üöÄ Deploying POC Application"
                  echo "Triggered by source branch: ${{ github.event.inputs.branch_name || github.ref_name }}"
                  echo "Target environment: ${{ github.event.inputs.environment || 'staging' }}"
                  echo "Tina content branch: ${{ github.event.inputs.tina_branch || 'default' }}"
                  echo "Build timestamp: ${{ env.BUILD_TIMESTAMP }}"
                  echo "Build version: ${{ env.VERSION_DEPLOYED }}"

            - name: Azure CLI - Login
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Set deployment slot
              id: slot
              run: |
                  ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
                  if [ "$ENVIRONMENT" = "production" ]; then
                      echo "slot_name=pre-production" >> $GITHUB_OUTPUT
                      echo "Deploying to pre-production slot for production environment"
                  else
                      echo "slot_name=" >> $GITHUB_OUTPUT
                      echo "Deploying without slot (staging environment)"
                  fi

            - name: Configure Auth0 and Build Info app settings
              run: |
                  SLOT_NAME="${{ steps.slot.outputs.slot_name }}"

                  # Build command as array for safe execution
                  CMD=(
                    az webapp config appsettings set
                    --name "${{ needs.infrastructure.outputs.appServiceName }}"
                    --resource-group "${{ needs.infrastructure.outputs.resourceGroup }}"
                  )

                  # Add slot parameter only if slot name is provided
                  if [ -n "$SLOT_NAME" ]; then
                    CMD+=(--slot "$SLOT_NAME")
                  fi

                  # Add settings and output flag
                  CMD+=(
                    --settings
                    "TINA_WEBHOOK_SECRET=${{ secrets.TINA_WEBHOOK_SECRET }}"
                    "AUTH0_DOMAIN=${{ vars.AUTH0_DOMAIN }}"
                    "AUTH0_CLIENT_ID=${{ vars.AUTH0_CLIENT_ID }}"
                    "AUTH0_CLIENT_SECRET=${{ secrets.AUTH0_CLIENT_SECRET }}"
                    "AUTH0_SECRET=${{ secrets.AUTH0_SECRET }}"
                    "AUTH0_REDIRECT_URI=${{ vars.AUTH0_REDIRECT_URI }}"
                    "AUTH0_AUDIENCE=${{ vars.AUTH0_AUDIENCE }}"
                    "GH_APP_ID=${{ vars.GH_APP_ID }}"
                    "GH_APP_PRIVATE_KEY=${{ secrets.GH_APP_PRIVATE_KEY }}"
                    "GITHUB_APP_INSTALLATION_ID=${{ secrets.GITHUB_APP_INSTALLATION_ID }}"
                    "CRM_TENANT=${{ vars.CRM_TENANT }}"
                    "CRM_TENANT_ID=${{ vars.CRM_TENANT_ID }}"
                    "CRM_APP_ID=${{ vars.CRM_APP_ID }}"
                    "CRM_SCOPE=${{ vars.CRM_SCOPE }}"
                    "CRM_VIEW_CURRENT=${{ vars.CRM_VIEW_CURRENT }}"
                    "CRM_VIEW_PAST=${{ vars.CRM_VIEW_PAST }}"
                    "CRM_APP_SECRET=${{ secrets.CRM_APP_SECRET }}"
                    "NEXT_PUBLIC_API_BASE_URL=${{ vars.NEXT_PUBLIC_API_BASE_URL }}"
                    "NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING=${{ secrets.NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING }}"
                    "BUILD_TIMESTAMP=${{ env.BUILD_TIMESTAMP }}"
                    "VERSION_DEPLOYED=${{ env.VERSION_DEPLOYED }}"
                    "DEPLOYMENT_URL=${{ env.DEPLOYMENT_URL }}"
                    "BUILD_DATE=${{ env.BUILD_DATE }}"
                    "NEXT_PUBLIC_TINA_BRANCH=${{ vars.NEXT_PUBLIC_TINA_BRANCH }}"
                    "COMMIT_HASH=${{ env.COMMIT_HASH }}"
                    --output none
                  )

                  # Execute the command
                  "${CMD[@]}"

            - name: Deploy to Azure Web App (Production with slot)
              if: github.event.inputs.environment == 'production'
              uses: azure/webapps-deploy@v3
              with:
                  app-name: ${{ needs.infrastructure.outputs.appServiceName }}
                  images: ${{ needs.build.outputs.image_tag }}
                  slot-name: ${{ steps.slot.outputs.slot_name }}

            - name: Deploy to Azure Web App (Staging)
              if: github.event.inputs.environment != 'production'
              uses: azure/webapps-deploy@v3
              with:
                  app-name: ${{ needs.infrastructure.outputs.appServiceName }}
                  images: ${{ needs.build.outputs.image_tag }}

            - name: Swap slots (production only)
              if: github.event.inputs.environment == 'production'
              run: |
                  echo "üîÑ Swapping pre-production slot with production slot..."
                  az webapp deployment slot swap \
                      --name ${{ needs.infrastructure.outputs.appServiceName }} \
                      --resource-group ${{ needs.infrastructure.outputs.resourceGroup }} \
                      --slot pre-production \
                      --target-slot production
                  echo "‚úÖ Slot swap completed successfully!"


            - name: Verify deployment
              run: |
                  echo "‚úÖ Application deployed successfully!"
                  echo "Image: ${{ needs.build.outputs.image_tag }}"
                  echo "App URL: https://${{ needs.infrastructure.outputs.appServiceHostName }}"
                  echo "Source: ${{ github.event.inputs.branch_name || github.ref_name }}"
                  echo "Build Info:"
                  echo "  üìÖ Deployed: ${{ env.BUILD_DATE }}"
                  echo "  üè∑Ô∏è Version: ${{ env.VERSION_DEPLOYED }}"
                  echo "  üîó Build Details: ${{ env.DEPLOYMENT_URL }}"

    # ============================================================================
    # POST-DEPLOYMENT SITEMAP CRAWL
    # ============================================================================
    crawl_sitemap:
        name: Crawl Sitemap
        if: github.event.inputs.environment == 'production'
        needs: deploy
        uses: ./.github/workflows/crawl-sitemap.yml
        with:
            sitemap_url: https://www.ssw.com.au/rules/sitemap-index-0.xml