name: Deploy Pull Request to Staging Slot
on:
  issue_comment:
    types: [created]

concurrency:
  group: pr-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read
  actions: write
  pull-requests: write

jobs:
  # ============================================================================
  # VALIDATE /deploy COMMAND
  # ============================================================================
  validate:
    name: Validate Deploy Command
    if: >-
      github.event.issue.pull_request &&
      github.event.comment.body == '/deploy'
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      head_ref: ${{ steps.pr.outputs.head_ref }}
      head_sha: ${{ steps.pr.outputs.head_sha }}
    steps:
      - name: Get PR details
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          PR_STATE=$(echo "$PR_DATA" | jq -r '.state')

          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

          echo "PR #$PR_NUMBER"
          echo "  State: $PR_STATE"
          echo "  Branch: $HEAD_REF"
          echo "  SHA: $HEAD_SHA"

          if [ "$PR_STATE" != "open" ]; then
            echo "::error::PR #$PR_NUMBER is not open (state: $PR_STATE)"
            exit 1
          fi

      - name: Add reaction to comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content='rocket' --silent

  # ============================================================================
  # INFRASTRUCTURE DEPLOYMENT
  # ============================================================================
  infrastructure:
    name: Deploy Infrastructure
    needs: validate
    uses: ./.github/workflows/deploy-infrastructure.yml
    with:
      environment: staging
      slot_name: pr-${{ needs.validate.outputs.pr_number }}
      ref: ${{ needs.validate.outputs.head_sha }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_SERVICE_PRINCIPAL_OBJECT_ID: ${{ secrets.AZURE_SERVICE_PRINCIPAL_OBJECT_ID }}

  # ============================================================================
  # BUILD AND PUSH CONTAINER
  # ============================================================================
  build:
    name: Build and Push Container
    needs: [validate, infrastructure]
    uses: ./.github/workflows/build-artifacts.yml
    with:
      tag: pr-${{ needs.validate.outputs.pr_number }}
      acr_name: ${{ needs.infrastructure.outputs.acrName }}
      image_name: ssw-rules
      source_branch: ${{ needs.validate.outputs.head_ref }}
      tina_branch: ${{ needs.validate.outputs.head_ref }}
      ref: ${{ needs.validate.outputs.head_sha }}
      environment: staging
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TINA_TOKEN: ${{ secrets.TINA_TOKEN }}
      TINA_SEARCH_TOKEN: ${{ secrets.TINA_SEARCH_TOKEN }}
      TINA_WEBHOOK_SECRET: ${{ secrets.TINA_WEBHOOK_SECRET }}
      NEXT_PUBLIC_TINA_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_TINA_CLIENT_ID }}
      NEXT_PUBLIC_ALGOLIA_APP_ID: ${{ secrets.NEXT_PUBLIC_ALGOLIA_APP_ID }}
      NEXT_PUBLIC_ALGOLIA_ADMIN_KEY: ${{ secrets.NEXT_PUBLIC_ALGOLIA_ADMIN_KEY }}
      NEXT_PUBLIC_ALGOLIA_INDEX_NAME: ${{ secrets.NEXT_PUBLIC_ALGOLIA_INDEX_NAME }}
      NEXT_PUBLIC_ALGOLIA_API_KEY: ${{ secrets.NEXT_PUBLIC_ALGOLIA_API_KEY }}
      NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
      NEXT_PUBLIC_GTM_CONTAINER_ID: ${{ secrets.NEXT_PUBLIC_GTM_CONTAINER_ID }}
      NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING: ${{ secrets.NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING }}
      GH_APP_ID: ${{ vars.GH_APP_ID }}
      GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
      GITHUB_APP_INSTALLATION_ID: ${{ secrets.GITHUB_APP_INSTALLATION_ID }}

  # ============================================================================
  # DEPLOY TO PR SLOT
  # ============================================================================
  deploy:
    name: Deploy to PR Slot
    runs-on: ubuntu-latest
    needs: [validate, infrastructure, build]
    environment: staging
    steps:
      - name: Use build info from build job
        id: build_info
        run: |
          BUILD_TIMESTAMP="${{ needs.build.outputs.build_timestamp }}"
          BUILD_DATE="${{ needs.build.outputs.build_date }}"
          COMMIT_HASH="${{ needs.build.outputs.commit_hash }}"
          VERSION_DEPLOYED="${{ needs.build.outputs.version_deployed }}"
          DEPLOYMENT_URL="${{ needs.build.outputs.deployment_url }}"

          echo "BUILD_TIMESTAMP=$BUILD_TIMESTAMP" >> $GITHUB_ENV
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "VERSION_DEPLOYED=$VERSION_DEPLOYED" >> $GITHUB_ENV
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV

          echo "Using Build Info from Build Job:"
          echo "  Timestamp: $BUILD_TIMESTAMP"
          echo "  Date: $BUILD_DATE"
          echo "  Version: $VERSION_DEPLOYED"
          echo "  Commit: $COMMIT_HASH"
          echo "  Deployment URL: $DEPLOYMENT_URL"

      - name: Log deployment info
        run: |
          echo "Deploying PR Preview"
          echo "PR Number: ${{ needs.validate.outputs.pr_number }}"
          echo "Source branch: ${{ needs.validate.outputs.head_ref }}"
          echo "Slot name: ${{ needs.infrastructure.outputs.slotName }}"
          echo "Build timestamp: ${{ env.BUILD_TIMESTAMP }}"
          echo "Build version: ${{ env.VERSION_DEPLOYED }}"

      - name: Azure CLI - Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure app settings for PR slot
        run: |
          az webapp config appsettings set \
            --name "${{ needs.infrastructure.outputs.appServiceName }}" \
            --resource-group "${{ needs.infrastructure.outputs.resourceGroup }}" \
            --slot "${{ needs.infrastructure.outputs.slotName }}" \
            --settings \
            "WEBSITES_ENABLE_APP_SERVICE_STORAGE=false" \
            "DOCKER_REGISTRY_SERVER_URL=https://${{ needs.infrastructure.outputs.acrName }}.azurecr.io" \
            "WEBSITES_PORT=3000" \
            "APPLICATIONINSIGHTS_CONNECTION_STRING=${{ secrets.NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING }}" \
            "TINA_WEBHOOK_SECRET=${{ secrets.TINA_WEBHOOK_SECRET }}" \
            "AUTH0_DOMAIN=${{ vars.AUTH0_DOMAIN }}" \
            "AUTH0_CLIENT_ID=${{ vars.AUTH0_CLIENT_ID }}" \
            "AUTH0_CLIENT_SECRET=${{ secrets.AUTH0_CLIENT_SECRET }}" \
            "AUTH0_SECRET=${{ secrets.AUTH0_SECRET }}" \
            "AUTH0_REDIRECT_URI=${{ vars.AUTH0_REDIRECT_URI }}" \
            "AUTH0_AUDIENCE=${{ vars.AUTH0_AUDIENCE }}" \
            "GITHUB_API_PAT=${{ secrets.GH_API_PAT }}" \
            "GH_APP_ID=${{ vars.GH_APP_ID }}" \
            "GH_APP_PRIVATE_KEY=${{ secrets.GH_APP_PRIVATE_KEY }}" \
            "GITHUB_APP_INSTALLATION_ID=${{ secrets.GITHUB_APP_INSTALLATION_ID }}" \
            "CRM_TENANT=${{ vars.CRM_TENANT }}" \
            "CRM_TENANT_ID=${{ vars.CRM_TENANT_ID }}" \
            "CRM_APP_ID=${{ vars.CRM_APP_ID }}" \
            "CRM_SCOPE=${{ vars.CRM_SCOPE }}" \
            "CRM_VIEW_CURRENT=${{ vars.CRM_VIEW_CURRENT }}" \
            "CRM_VIEW_PAST=${{ vars.CRM_VIEW_PAST }}" \
            "CRM_APP_SECRET=${{ secrets.CRM_APP_SECRET }}" \
            "NEXT_PUBLIC_API_BASE_URL=${{ vars.NEXT_PUBLIC_API_BASE_URL }}" \
            "NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING=${{ secrets.NEXT_PUBLIC_APPLICATIONINSIGHTS_CONNECTION_STRING }}" \
            "BUILD_TIMESTAMP=${{ env.BUILD_TIMESTAMP }}" \
            "VERSION_DEPLOYED=${{ env.VERSION_DEPLOYED }}" \
            "DEPLOYMENT_URL=${{ env.DEPLOYMENT_URL }}" \
            "BUILD_DATE=${{ env.BUILD_DATE }}" \
            "NEXT_PUBLIC_TINA_BRANCH=${{ vars.NEXT_PUBLIC_TINA_BRANCH }}" \
            "COMMIT_HASH=${{ env.COMMIT_HASH }}" \
            --output none

      - name: Deploy to PR Slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ needs.infrastructure.outputs.appServiceName }}
          images: ${{ needs.build.outputs.image_tag }}
          slot-name: ${{ needs.infrastructure.outputs.slotName }}

      - name: Verify deployment
        run: |
          echo "PR Preview deployed successfully!"
          echo "Image: ${{ needs.build.outputs.image_tag }}"
          echo "Preview URL: https://${{ needs.infrastructure.outputs.slotHostName }}"
          echo "Source branch: ${{ needs.validate.outputs.head_ref }}"
          echo "Build Info:"
          echo "  Deployed: ${{ env.BUILD_DATE }}"
          echo "  Version: ${{ env.VERSION_DEPLOYED }}"
          echo "  Build Details: ${{ env.DEPLOYMENT_URL }}"

  # ============================================================================
  # POST PR COMMENT WITH PREVIEW URL
  # ============================================================================
  comment:
    name: Post Preview URL Comment
    runs-on: ubuntu-latest
    needs: [validate, infrastructure, deploy]
    environment: staging
    steps:
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ needs.validate.outputs.pr_number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- pr-preview-comment -->'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ needs.validate.outputs.pr_number }}
          edit-mode: replace
          body: |
            <!-- pr-preview-comment -->
            ## PR Preview Deployed

            | | |
            |---|---|
            | **Preview URL** | https://${{ needs.infrastructure.outputs.slotHostName }}${{ vars.NEXT_PUBLIC_BASE_PATH }} |
            | **Slot Name** | `${{ needs.infrastructure.outputs.slotName }}` |
            | **Branch** | `${{ needs.validate.outputs.head_ref }}` |
            | **Commit** | `${{ needs.validate.outputs.head_sha }}` |

            ---
            <sub>This preview will be automatically deleted when the PR is closed.</sub>
